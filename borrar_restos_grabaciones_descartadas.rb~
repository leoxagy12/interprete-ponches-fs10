puts "--------------------------------------------------------------------------------"

#Este script borra los archivos de grabaciones corruptios del sistema de vigilancia Zavio CamGrava, 
#en caso de ser declarados como tal por el software de restauracion de la base de datos del mismo programa.

#Se necesita tomar del archivo de repore de corruptos 

directorio_archivos_grabaciones = 'C:\Archivos de programa\ZAVIO\IPSurveillance'

puts "Directorio de grabaciones: " + directorio_archivos_grabaciones
puts

if File.directory?(directorio_archivos_grabaciones)
	begin
		carpetas_de_video = Array.new
		
		Dir.chdir directorio_archivos_grabaciones
		Dir["*"].each do |contenido|
			if File.directory?(File.join(directorio_archivos_grabaciones, contenido))
				if contenido.length == 8
					if contenido =~ /(\d{4})(\d{2})(\d{2})/
						ano = $1.to_i
						mes = $2.to_i
						dia = $3.to_i
						
						if ano >= 2006 and (1..12) === mes and (1..31) === dia
							puts "Carpeta: #{contenido} => Fecha: #{dia}-#{mes}-#{ano} " 
							
							carpeta = Hash.new
							carpeta["ruta"] = File.join(directorio_archivos_grabaciones, contenido)
							carpeta["ano"] = ano
							carpeta["mes"] = mes
							carpeta["dia"] = dia
							#carpeta["suma"] = dia + mes + ano
							
							carpetas_de_video << carpeta	
						else	
							puts "Carpeta: #{contenido} => NO TIENE EL FORMATO DE FECHA ADECUADO" 
						end			
					end
				end
			end
		end
		
		sumas = Array.new
		carpetas_de_video.each do |carpeta|
			sumas << ( carpeta["ano"] + carpeta["mes"] + carpeta["dia"] ) #carpeta["suma"]
		end
				
		carpetas_de_video.each do |carpeta|
			if carpeta["suma"] == sumas.max
				puts carpeta["ruta"]
			end
		end
	rescue Exception => e
		print "ERROR borrando restos: "
		puts  e
	end
else
	puts "ERROR: directorio mal especificado."
end

puts
puts "--------------------------------------------------------------------------------"

puts "Precione Ctrl + C para salir..."
STDIN.getc
